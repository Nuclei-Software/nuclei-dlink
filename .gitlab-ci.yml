image: mhoiting/platformio-cli-gd32v-docker:v0.2.0

stages:
    - build
    - publish

build:
    stage: build
    script:
        - pio --no-ansi run -e gd32vf103c-start -e sipeed-longan-nano -e sipeed-longan-nano-alt -e rvl-probe
    artifacts:
        name: "firmware"
        expire_in: 1 week
        paths:
            - .pio/build/**/rvlink_fw_*.elf
            - .pio/build/**/rvlink_fw_*.bin
            - .pio/build/**/rvlink_fw_*.hex
        when: always

publish:
    stage: publish
    needs: ["build"]
    only:
        - tags
    except:
        - branches
    script:
        - ./scripts/gitlab-publish.sh
